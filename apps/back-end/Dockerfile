FROM node:18-alpine

# Instalar depend√™ncias de build necess√°rias para m√≥dulos nativos (bcrypt)
RUN apk add --no-cache python3 make g++ netcat-openbsd

WORKDIR /app

# Copiar package files
COPY package*.json ./

# Instalar depend√™ncias (sem --ignore-scripts para compilar bcrypt)
RUN npm install

# Copiar c√≥digo fonte
COPY . .

EXPOSE 3000

# Script de inicializa√ß√£o melhorado
CMD sh -c "echo '‚è≥ Aguardando PostgreSQL estar pronto...' && \
  export DB_HOST=postgres && \
  until nc -z postgres 5432; do \
    echo 'Aguardando PostgreSQL em postgres:5432...'; \
    sleep 2; \
  done && \
  echo '‚úÖ PostgreSQL est√° pronto!' && \
  sleep 2 && \
  echo 'üì¶ Executando migrations...' && \
  DB_HOST=postgres npm run migration:run && \
  echo '‚úÖ Migrations executadas com sucesso!' && \
  echo 'üöÄ Iniciando aplica√ß√£o NestJS...' && \
  DB_HOST=postgres npm run start:dev"